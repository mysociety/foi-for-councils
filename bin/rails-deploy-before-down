#!/bin/bash

set -e
[[ "$TRACE" ]] && set -x

rails_root="$(dirname "$0")/.."
vhost_root="$(cd "$rails_root"/.. && pwd)"
shared_dir="$vhost_root"/shared

# Change to Rails root
cd "$rails_root"

# Install gems into shared path that persists between deploys
mkdir -p "$shared_dir"/vendor/bundle
ln -snf "$shared_dir"/vendor/bundle vendor/bundle

# Install node_modules into shared path that persists between deploys
mkdir -p "$shared_dir"/vendor/node_modules
ln -snf "$shared_dir"/vendor/node_modules vendor/node_modules

# Symlink logs directory
ln -snf "$vhost_root"/applogs log

bin/bundle config set deployment 'true'
bin/bundle config set path 'vendor/bundle'
bin/bundle config set without 'development test'
bin/bundle install

bin/yarn config set path 'vendor/node_modules'
bin/yarn install --ignore-engines \
  --ignore-optional \
  --ignore-scripts \
  --production \
  --pure-lockfile

bin/rails assets:precompile
